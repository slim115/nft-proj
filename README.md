:smiley: Please preview README in github for better visualization and experience :smiley: 
:red_circle: Please contact me at slim115@e.ntu.edu.sg if there are any issues!
# CE/CZ4153 Blockchain Technology Development Project
## Project topic 5: Pendle: Liquidity Mining with NFTs as Rewards alongside PENDLE

### Contents
- [General Overview](#general-overview)
- [Terminology Clarification](#before-starting-we-should-straighten-out-some-terminology)
- [Understanding of the Problem](#detailed-understanding-of-the-problem)
- [Engineering Plans](#engineering-plans-we-had)
- [Steps to accomplish these Plans](#steps-needed-to-accomplish-these-plans)
- [Bonuses](#bonuses-we-added)
- [Usage of code](#usage-of-code)

### General Overview:
1. A liquidity provider (LP) will be rewarded with the Pendle tokens when he provides liquidity to the liquidity pool. :droplet:
2. He will be able to stake his Pendle tokens for interests and be paid in Pendle tokens (reward and yield tokens) when redeeming them. :moneybag:
3. Besides that, he will gain points when staking certain amount of Pendle tokens for a certain period, which he can then redeem NFTs by using the points. :framed_picture:

### Before starting, we should straighten out some terminology:
1. Pendle Tokens consists of 
    - _stakeToken_ which is the token to be used to stake into this contract to receive rewards.
    - _yieldToken_ which is the token generated by stakeToken while it's being staked.
2. LP Tokens mentioned in the *Project Description* will be referred here as _stakeToken_. 

### Detailed Understanding of the problem:
Given the massive development of the NFT space, it will be greatly beneficial if NFT is supported in the current Pendle liquidity mining contract. Therefore, our development project aims to integrate liquidity mining with NFTs (non-fungible tokens) as rewards with Pendle.  
1. Supporting ERC-721 enumerable NFTs as rewards.
2. The reward mechanism of PENDLE tokens should remain unchanged (linearly vested over epochs).
3. A method to track the reward points proportional to the amount of _stakeToken_ provided by the user to represent when he is eligible to claim an NFT.
4. A configurable exchange rate of rewards points to an NFT.
5. Reward points can only be accumulated when _stakeToken_ are staked.

### Engineering plans we had:
We initially tried to integrate more with Pendle Environment by using the contract addresses of IPendleLiquidityMiningV2 and the PendleToken already deployed. <br /> :bangbang: However, we could not access their contracts when trying to mint or transfer tokens. <br />
:ballot_box_with_check: Decided to go with mocking up our own Liquidity Pool environment with our tokens and NFTs.
1. :muscle: Understanding the workflow: <br />
    - Start with the Back End, write the smart contracts for the ERC20 tokens, ERC721 tokens and Liquidity Pool on [Visual Studio Code editor](https://code.visualstudio.com/) with the [Solidity plugin](https://marketplace.visualstudio.com/items?itemName=JuanBlanco.solidity)
    - Deploy on the [Kovan Testnet](https://kovan.etherscan.io/) using [Alchemy](https://www.alchemy.com/) as node provider since Pendle projects have been testing on the Kovan Testnet in the past.
    - Develop the Front End application for the User Interface.
    - Integrate the Front End with the Back End for the project completion!
2. :muscle: Choosing which technology to use: <br />
    - Decide on which framework to use for developing the smart contracts, either [Truffle](https://trufflesuite.com/) or [Hardhat](https://hardhat.org/) -> Decided with **Hardhat** as it is becoming more widely adopted. <br />
    - Decide on which framework to use for the front-end, either [React](https://reactjs.org/) or [HTML](https://www.w3schools.com/html/) -> Decided with **React** as it has good coverage of debuggind and design tools. <br />
    - Decide on whether to use either LocalHost or Hosting website on Server -> Decided with **LocalHost** for simplicity of the project. <br />
3. :muscle: Smart Contract Considerations: <br />
    - Implementing the _redeemnft_ function in the Liquidity Pool contract. <br />
     - Uses the points specified to determine which NFT to give as reward. 
     - NFT is minted once the user claims his reward i.e NFTs are not minted one shot.
    - Linear Vesting of PENDLE tokens (_stakeToken_ and _yieldToken_) concept is kept where the global variables _numberOfEpochs_ and _epochDuration_ can be configured prior to the smart contract deployment.
    - Implementing the _pointsOf_ function to track the reward points proportional to the amount of _stakeToken_ staked by user. Note: reward points only awarded when _stakeToken_ are staked. In our case, we decided to reward points 2x of the amount of _stakeToken_ staked i.e 2 _stakeToken_ staked = 4 points.
    - Implementing the _transferPendingNFTrewards_ function to configure the exchange rate of reward points to NFT. In our case, for example, the common NFT equates to 1000 points. Can be configured by changing the global variable _NFT CONSTANT_.
4. :muscle: User Interface Considerations: <br />
    - Since User Interface is not the focal point of the project, we decided to go with a **simple user interface** that is able to show important features such as the "amount of tokens staked", "amount of tokens earned", "amount of points", "reward rate", "number of points correspond to which NFT".
    - Look at the diagram below for a better understanding: <br />
    ![This is an image](https://gateway.pinata.cloud/ipfs/QmNeznaBpTW14AJAbGk4CYZNxKjETTkjc6XjFwqKU1u17q)
    ![This is an image](https://gateway.pinata.cloud/ipfs/QmXH7MRXrGejYBm6a7sZBKzNHi9Mbc3XdrHaghyQWQwZiQ)

### Steps needed to accomplish these plans:
1. Read up on the resources needed for this project: [ERC20 Token Standard](https://ethereum.org/en/developers/docs/standards/tokens/erc-20/), [ERC721 Token Standard](https://ethereum.org/en/developers/docs/standards/tokens/erc-721/), [How do Liquidity Pools work](https://academy.binance.com/en/articles/what-are-liquidity-pools-in-defi), [How to use Alchemy](https://www.alchemy.com/), [How to write and deploy NFT contract](https://ethereum.org/en/developers/tutorials/how-to-write-and-deploy-an-nft/), [How to integrate React with Solidity smart contracts](https://docs.alchemy.com/alchemy/tutorials/hello-world-smart-contract/part-4). :white_check_mark:
2. Practice writing smart contracts and familiarizing with the flow: [CryptoZombies Platform](https://cryptozombies.io/), [Development Workshop](https://github.com/BlockchainCourseNTU/hello-dapp/), [Last Year's Development Workshop](https://github.com/BlockchainCourseNTU/resource/tree/master/development/hello-dapp). :white_check_mark:
3. Using [Pendle-Core Repo and its smart contracts](https://github.com/pendle-finance/pendle-core) as a guide, to mock up the Liquidity Pool environment. :white_check_mark:
4. Getting Kovan ETH from the [Kovan Faucet](https://app.mycrypto.com/faucet) so that we can test, test and test again! :white_check_mark:

### Bonuses we added: 
:+1: :+1: :+1: 
1. Implementing quadratic rewards i.e More _stakeToken_ staked = even more rewards.
2. Besides linearly vesting, lock up period of 1 epoch is implemented so users will not manipulate the pool for the rewards i.e Users are forced to redeem rewards only after 1 epoch.
3. Implementing lockup of reward points so users can only redeem NFTs after all the epochs have ended.
4. Simulating the Liquidity Pool concept by minting 2 ERC20 tokens to the user so he/she can 'provide liquidity' to the pool in order to get his _stakeToken_.

### Usage of code:
#### Step 0: Prerequisite & Installation
In this section, we will go through the tools and dependencies required to be installed before the kick-start of our project. <br />

First, make a new folder and unzip the GroupName.zip file submitted through NTULearn <br />
Now, open your **terminal** or **powershell** to make sure the following are installed: <br />
1. [npm](https://docs.npmjs.com/getting-started) or [yarn](https://classic.yarnpkg.com/en/docs/install/#windows-stable): <br />
```
# Check npm or yarn is installed
npm -v yarn-v
```
2. [node v8.9.4 or later](https://nodejs.org/en/): <br />
```
# Check nodejs is installed
node -v
```
3. [hardhat](https://hardhat.org/getting-started/): <br /> 
```
npm install --save-dev hardhat
``` 
4. [Metamask extension](https://metamask.io/download.html): <br /> 
Create at least one account and make sure there is enough funds using a [Kovan Faucet](https://app.mycrypto.com/faucet). <br />
Click on the Metmask extension -> 3 dots -> Account Details -> Export Private Key -> Enter your password -> **Copy your private key** (You will need this later!)
5. Connect to the ethereum network: <br /> 
Create a free account on [Alchemy](https://www.alchemy.com/). Create your own App (Make sure Kovan network is selected!) and **get your wss API key**. (You will need this later!)
6. Connect Metamask and Alchemy to Project: <br />
First, install the dotenv package in your project directory <br />
```
npm install dotenv --save
```
Then, create a .env file in the root directory of the project, and add your MetaMask private key and Alchemy API URL to it as such: <br />
```
API_URLL="wss://eth-kovan.alchemyapi.io/v2/your-api-key"
PRIVATE_KEY="your-metamask-private-key"
```
7. Install [ethers.js](https://docs.ethers.io/v5/)
```
npm install --save-dev @nomiclabs/hardhat-ethers 
```
8. Extra step: For Testing (However, we used test cases minimally and mostly for debugging purposes) 
```
npm install --save-dev @nomiclabs/hardhat-waffle ethereum-waffle chai ethers
```

#### Step 1: Deploy your smart contracts on the Kovan Network
In this section, we will deploy the smart contracts in order.
1. Before deploying, head over to the **/scripts/deploy.js** and check that lines 22-24 are commented out. This is because the pool contract requires the other contract addresses, hence we deploy the 5 contracts first by running in the root folder: <br />
```
# Deploying the first 5 contracts to the Kovan network
npx hardhat run scripts/deploy.js --network kovan
```
2. Once done, take note of their contract addresses respectively and head over to /contracts/pool.sol. Update accordingly: <br />
```
address MyTokenAddress = your-nft-token-address; // NFT token from mynft.sol
...
Factory = factory(your-stake-token-address); // LP Stake Token from factory.sol
Mytoken1 = mytoken1(your-mtk1-token-address); // LP pairing 1 from mytoken1.sol
Mytoken2 = mytoken2(your-mtk2-token-address); // LP pairing 2 from mytoken2.sol
YieldToken = yieldtoken(your-yield-token-address); // Yield Token from yieldtoken.sol
```
3. Before deploying, Take note that the _numberOfEpochs_ and _epochDuration_ have been chosen to be 10 and 60 respectively for simple demonstration purposes. You may change accordingly if you want to. <br />
```
uint public numberOfEpochs = 10;
uint public epochDuration = 60;
```
4. Now, head back to **/scripts/deploy.js** and comment lines 2-20 and uncomment lines 22-24. Deploy the pool contract now: <br />
```
# Deploying the pool contract to the Kovan network
npx hardhat run scripts/deploy.js --network kovan
```
#### Step 2: Linking with the Front-End
Congrats! :rainbow: We are finally done with deploying our contracts! Now with contract addresses, we have to link with the Front-End. 
1. Head over to /my-app/src/pool.js and populate the addresses once again: <br />
```
export const myAddress = "your-user-address"; // Copy paste from Metamask extension
export const fromAddress = "your-user-address"; // For Simplicity sake, you can use your address
export const forAddress = "your-user-address"; // For Simplicity sake, you can use your address
export const factoryAddress = "your-stake-token-address";
export const yieldAddress = "your-yield-token-address";

const alchemyWSS = `wss://eth-kovan.alchemyapi.io/v2/your-api-key`; 

export const PoolContractAddress = "your-pool-contract-address";
```
2. Do the same for 5 more javascripts in the same folder (It's troublesome but jiayou! :muscle:): <br />
    -./redeemnfts.js <br />
    -./redeemreward.js <br />
    -./redeeminterest.js <br />
    -./staking.js <br />
    -./provideliquidity.js <br />
    
#### Step 3: Launch the Front-End Application
Now, the moment we have been waiting for! 
1. Make sure you are in the /root-folder/my-app directory and run: <br />
```
npm start
```
2. Yay! Now the application should be running on the React App - localhost:3000
#### Step 4: Using the Liquidity Pool Functions 
Alright, now the fun part! <br />
Now, open your metamask wallet (make sure you are on the kovan network) and you should see your Kovan ETH but where are the other tokens? <br />
Well we got to import them! Scroll down and go to "Import tokens" <br />
![This is an image](https://gateway.pinata.cloud/ipfs/QmXuk86PJjUmYgbMXrkTxSy8b58VQJ1YHuiNWKQTciCgFR) <br />
Now copy paste the token address into the "Token Contract Address" field and "Add Custom Token" <br />
![This is an image](https://gateway.pinata.cloud/ipfs/QmbSr2XqY3DdqfXVsfDvM3g66D923fuooCSANdZ4WYNXJg) <br />
Make sure to do the same for 4 of the contract addresses: _MyToken1_, _MyToken2_, _StakeToken_, _YieldToken_ <br />
Now you should be able to see all the tokens! :rainbow: Need to change image ! <br /> 
![This is an image](https://gateway.pinata.cloud/ipfs/QmNeznaBpTW14AJAbGk4CYZNxKjETTkjc6XjFwqKU1u17q) <br />

You will notice that you have 10,000 _MTK1_ and 10,000 _MTK2_ as they were minted to you when you deployed their contract. <br />
Now as a Liquidity Provider, we will start by 'providing liquidity' to this pool. 
    
